vida = {
  number: function(n) {
    return +n;
  },
  string: function(s) {
    return s;
  }  
}

var createCanvasStyle = function(styleBody) {

  // remove existing style if any
  $('#canvas-style').remove()
  var style = $("<style>")
                .attr({
                  type: 'text/css',
                  id: 'canvas-style'
                })
                .html(styleBody)

  $("head").append(style)
}

// code from SO
// http://stackoverflow.com/questions/19053827/csv-separator-auto-detection-in-javascript
guessDelimiters = function (text, possibleDelimiters) {
  return possibleDelimiters.filter(weedOut);

  function weedOut (delimiter) {
    var cache = -1;
    return text.split('\n').every(checkLength);

    function checkLength (line) {
        if (!line) {
            return true;
        }

        var length = line.split(delimiter).length;
        if (cache < 0) {
            cache = length;
        }
        return cache === length && length > 1;
    }
  }
}

// Convert JSON/CSV/TSV text to JSON and return format in { columns: [], data: []}
var dataTextToJSON = function (dataText) {
  var result = {columns: [], data: []}
  
  if (!dataText) return result
  
  try {
    // Try JSON parse
    dataText = dataText.replace(/^\s+|\s+$/g, '')
    
    var json = JSON.parse(dataText),
        columns = null    
    if (Object.prototype.toString.call(json) === '[object Array]') {
      columns = Object.keys(json[0])
    } 
    result = { columns: columns, data: json }
  } catch (e) {
    // Try CSV/TSV parse
    try {
      var d = guessDelimiters(dataText,[',', '\t'])
      result = (d.length > 0 ? CSVToJSON(dataText, d[0]) : CSVToJSON(dataText, ','))    
    } catch (e) {
      console.log(e)
    }
  } 

  return result
}